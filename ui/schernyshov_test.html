<html>
    <head>
        <script src="http://www.html5canvastutorials.com/libraries/kinetic-v4.7.3-beta.js"></script>
    </head>
	<body>
    <div id="container"></div>
	  <script>
        // Инициализация страницы
        var friends = [{"name":"Ivan"}, {"name":"Vlad"}, {"name":"Anton"}, {"name":"Сергей"}, {"name":"Вован"}, {"name":"Петька"}];
	    var stageWidth = screen.width;
        var stageHeight = screen.height;
        var stage = new Kinetic.Stage({
            container: 'container',
            width: stageWidth,
            height: stageHeight
        });
        var layer = new Kinetic.Layer();
        stage.add(layer);

        
        // Надо вынести в константы, чтоль
        var radiusInc = 50;


        // Рисуем линию с кругом по случайным координатам!
        var myfriend = new Friend(null, choosePosition(), choosePosition(), layer);
        myfriend.appear();


        // Конструктор объекта типа "друг" (вообще-то он должен быть универсальным)
        function Friend(friend, start_point, end_point, layer) {
            // Круг
            var circle = null;
            var short_line_length = 10;

            // Начало линии
            var short_point = getPointOnLine(start_point, end_point, short_line_length);
            var line = new Kinetic.Line({
                points: [start_point.x, start_point.y, short_point.x, short_point.y],
                stroke: 'red',
                strokeWidth: 15,
                lineCap: 'round',
                lineJoin: 'round'
            });
            layer.add(line);

            // Анимация 
            this.appear = function() {
                var line_inc = 10;
                var currentLength = short_line_length;
                // Анимация развертки блогов и сообщений           
                var circleAnimation = new Kinetic.Animation(function(frame) {
                    var radius = circle.getRadius() + 1;
                    circle.setRadius(radius);
                    var point = {
                        x : line.getPoints()[1].x - radiusInc,
                        y : line.getPoints()[1].y
                    };
                    if (circle.intersects(point)) {
                        circleAnimation.stop();
                    }
                }, layer);

                var lineAnimation = new Kinetic.Animation(function(frame) {
                    currentLength += line_inc;
                    var next_point = getPointOnLine(start_point, end_point, currentLength)
                    line.getPoints()[1].x = next_point.x;
                    line.getPoints()[1].y = next_point.y;
                    if (pointsEquals(next_point, end_point)) {
                        lineAnimation.stop();
                        circle = new Kinetic.Circle({
                            x: line.getPoints()[1].x,
                            y: line.getPoints()[1].y,
                            radius: 10,
                            fill: 'red'
                        });
                        layer.add(circle);
                        circleAnimation.start();
                    }
                }, layer);

                lineAnimation.start();
            }
        }

        function evalLineEndCoord(start_point, end_point) {
            var x = 10;
            var tg = (end_point.y - start_point.y) / (end_point.x - start_point.x);
            var y = tg * x;
            return {x : x, y : y};
        }


        function choosePosition() {
            var seed = 1000;
            return {x:Math.round(Math.random()*seed), y:Math.round(Math.random()*seed)};
        }

        function getPointOnLine(start_point, end_point, distance) {
            var dx = end_point.x - start_point.x;
            var dy = end_point.y - start_point.y;
            var fraction = Math.max(Math.abs(dx), Math.abs(dy)) / distance;
            if (fraction < 1) {
                return end_point;
            } else {
                var x = start_point.x + dx / fraction;
                var y = start_point.y + dy / fraction;
                return {x:Math.round(x), y:Math.round(y)};                   
            } 
        }

        function pointsEquals(start_point, end_point) {
            var result;
            if (start_point.x == end_point.x && start_point.y == end_point.y) {
                result = true;
            } else {
                result = false;
            }
            return result;
        }


	  </script>
	</body>
</html>